#!/usr/bin/env sh
set -e

S6_OVERLAY_VERSION=3.2.1.0

# Paths to a file describing the systempath install prefix, and a systemtap build archive,
# should be provided; these files are generated by a systemtap-builder container.
# The systemtap build will be copied into the runner image at that prefix.

BUILD_PREFIX_FILEPATH=${BUILD_PREFIX_FILEPATH:-.systemtap-build.prefix}
if [ ! -e "${BUILD_PREFIX_FILEPATH}" ]; then
	echo "Cannot find a build prefix file at '${BUILD_PREFIX_FILEPATH}'"
	exit 1
fi
SYSTEMTAP_PREFIX=$(cat ${BUILD_PREFIX_FILEPATH})

BUILD_ARCHIVE_FILEPATH=${BUILD_ARCHIVE_FILEPATH:-.systemtap-build.tar.gz}
echo "Using build-archive file at '${BUILD_ARCHIVE_FILEPATH}'"
if [ ! -e "${BUILD_ARCHIVE_FILEPATH}" ]; then
	echo "Cannot find a build archive at '${BUILD_ARCHIVE_FILEPATH}'"
	exit 1
fi
cp ${BUILD_ARCHIVE_FILEPATH} ./systemtap-runner/systemtap-build.tar.gz

# systemtap-runner setup differs significantly by distribution and version,
# so a RUNTIME_VERSION like "debian-12" or "ubuntu-24.04" MUST be specified.
if [ -z "${RUNTIME_VERSION}" ]; then
	echo "Missing required env var RUNTIME_VERSION"
	exit 1
fi
if [ ! -e "systemtap-runner/${RUNTIME_VERSION}.Dockerfile" ]; then
	echo "Cannot find a RUNTIME_VERSION dockerfile like '${RUNTIME_VERSION}.Dockerfile'"
	exit 1
fi

# The systemtap-runner image is specific to the host's kernel version,
# since systemtap itself has kernel-version-specific dependencies.
KERNEL_VERSION=$(uname -r)

# This script's first command-line argument must be a systemtap `.stp` script file.
# That .stp file will be mounted by the runner image when it starts.
STP_FILEPATH=$1
if [ -z "${STP_FILEPATH}" ]; then
	echo "Missing required argument STP_FILEPATH"
	exit 1
fi
STP_FILEPATH_REALPATH=$(realpath ${STP_FILEPATH})

docker build \
	-f systemtap-runner/${RUNTIME_VERSION}.Dockerfile \
	-t systemtap-runner/systemtap-runner-${RUNTIME_VERSION} \
	--build-arg S6_OVERLAY_VERSION=${S6_OVERLAY_VERSION} \
	--build-arg KERNEL_VERSION=${KERNEL_VERSION} \
	--build-arg SYSTEMTAP_PREFIX=${SYSTEMTAP_PREFIX} \
	./systemtap-runner

# NOTE: --privileged access, and the kernel debug mountpoint, are
# runtime requirements for systemtap to "tap" kernel functions.
docker run --rm \
	--privileged \
	--mount type=bind,source=/sys/kernel/debug,target=/sys/kernel/debug,readonly \
	--mount type=bind,source=${STP_FILEPATH_REALPATH},target=/run.stp,readonly \
	--name systemtap-runner \
	systemtap-runner-${RUNTIME_VERSION}
